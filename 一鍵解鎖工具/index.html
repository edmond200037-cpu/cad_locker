<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Locker Pro - ä¿®æ”¹å™¨</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="glass-glow"></div>
    <div class="container">
        <h1>CAD Locker æˆæ¬Šä¿®æ”¹å™¨</h1>

        <div id="dropZone" class="drop-zone">
            <div class="icon">ğŸ“</div>
            <p>å°‡å—ä¿è­·çš„ EXE æ‹–æ”¾åˆ°æ­¤è™• æˆ– é»æ“Šä¸Šå‚³</p>
            <input type="file" id="fileInput" style="display: none" accept=".exe">
        </div>

        <div id="controls" class="controls">
            <div class="file-info" id="fileInfo"></div>

            <div class="input-group">
                <label for="newLimit">æ–°çš„é–‹å•Ÿæ¬¡æ•¸é™åˆ¶ (å»ºè­° 1-99999)</label>
                <input type="number" id="newLimit" value="9999" min="1" max="999999">
            </div>

            <button id="patchBtn">å¥—ç”¨ä¿®æ”¹ä¸¦ä¸‹è¼‰</button>
            <div id="status" class="status"></div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const controls = document.getElementById('controls');
        const fileInfo = document.getElementById('fileInfo');
        const patchBtn = document.getElementById('patchBtn');
        const status = document.getElementById('status');
        const newLimitInput = document.getElementById('newLimit');

        let currentArrayBuffer = null;
        let fileName = '';

        dropZone.onclick = () => fileInput.click();

        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        };

        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');

        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFile(e.dataTransfer.files[0]);
        };

        function handleFile(file) {
            if (!file) return;
            if (!file.name.toLowerCase().endsWith('.exe')) {
                showStatus('è«‹ä¸Šå‚³ EXE æª”æ¡ˆ', 'error');
                return;
            }

            fileName = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                currentArrayBuffer = e.target.result;
                fileInfo.textContent = `æª”æ¡ˆ: ${fileName} (${(file.size / 1024).toFixed(1)} KB)`;
                controls.classList.add('visible');
                showStatus('æª”æ¡ˆå·²è¼‰å…¥ï¼Œæº–å‚™ä¿®æ”¹...', 'info');

                // å˜—è©¦åµæ¸¬ç•¶å‰é™åˆ¶
                detectCurrentLimit(currentArrayBuffer);
            };
            reader.readAsArrayBuffer(file);
        }

        function showStatus(msg, type) {
            status.textContent = msg;
            status.className = 'status ' + type;
        }

        function detectCurrentLimit(buffer) {
            const bytes = new Uint8Array(buffer);
            // æœå°‹çµå°¾é™„è¿‘çš„ CADLOCK æ¨™è¨˜ (43 41 44 4c 4f 43 4b 00)
            const sig = [0x43, 0x41, 0x44, 0x4c, 0x4f, 0x43, 0x4b, 0x00];
            let sigPos = -1;

            for (let i = bytes.length - sig.length; i >= bytes.length - 100; i--) {
                let match = true;
                for (let j = 0; j < sig.length; j++) {
                    if (bytes[i + j] !== sig[j]) { match = false; break; }
                }
                if (match) { sigPos = i; break; }
            }

            if (sigPos !== -1) {
                // æ ¹æ“šæœ€æ–°åˆ†æï¼šé™åˆ¶ä½ç½®æ˜¯åœ¨ sigPos - 24
                // çµæ§‹: [Limit(4)] [OtherData(20)] [CADLOCK(8)]
                const limitPos = sigPos - 24;
                const currentLimit = bytes[limitPos] | (bytes[limitPos + 1] << 8) | (bytes[limitPos + 2] << 16) | (bytes[limitPos + 3] << 24);
                showStatus(`åµæ¸¬åˆ° CADLOCK çµæ§‹ï¼ç›®å‰é™åˆ¶æ¬¡æ•¸ï¼š${currentLimit} æ¬¡ã€‚`, 'info');
                return limitPos;
            } else {
                showStatus('æ³¨æ„ï¼šæ‰¾ä¸åˆ°æ¨™æº–çš„ CADLOCK å°¾éƒ¨æ¨™è¨˜ï¼Œæ­¤æª”æ¡ˆå¯èƒ½å·²æå£æˆ–æ ¼å¼ä¸ç¬¦ã€‚', 'error');
                return -1;
            }
        }

        patchBtn.onclick = () => {
            if (!currentArrayBuffer) return;

            try {
                const bytes = new Uint8Array(currentArrayBuffer.slice(0));
                const limitPos = detectCurrentLimit(bytes);
                const newLimit = parseInt(newLimitInput.value);

                if (limitPos !== -1) {
                    // ä¿®æ”¹ 4 ä½å…ƒçµ„é™åˆ¶å€¼
                    bytes[limitPos] = newLimit & 0xFF;
                    bytes[limitPos + 1] = (newLimit >> 8) & 0xFF;
                    bytes[limitPos + 2] = (newLimit >> 16) & 0xFF;
                    bytes[limitPos + 3] = (newLimit >> 24) & 0xFF;

                    downloadPatchedFile(bytes);
                    showStatus(`ä¿®æ”¹æˆåŠŸï¼å·²å°‡é™åˆ¶è¨­ç‚º ${newLimit} æ¬¡ã€‚`, 'success');
                    alert("ã€ä¿®æ”¹æˆåŠŸã€‘\nè«‹è¨˜å¾—å°ä¸‹è¼‰çš„æª”æ¡ˆæŒ‰å³éµ -> ã€å…§å®¹ã€ -> å‹¾é¸ã€è§£é™¤é–å®šã€ï¼Œå¦å‰‡ Windows æœƒé˜»æ­¢åŸ·è¡Œã€‚");
                } else {
                    showStatus('ä¿®æ”¹å¤±æ•—ï¼šæ‰¾ä¸åˆ°ç›®æ¨™çµæ§‹ä½ç½®ã€‚', 'error');
                }

            } catch (err) {
                showStatus('åŸ·è¡Œå¤±æ•—: ' + err.message, 'error');
            }
        };

        function downloadPatchedFile(bytes) {
            const blob = new Blob([bytes], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.replace('.exe', '_patched.exe');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>